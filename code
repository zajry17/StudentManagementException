/*
 * 学生成绩管理系统
 * 功能：添加/删除/修改学生信息，成绩统计，文件存储
 * 设计模式：面向对象编程，使用STL容器
 * 作者：[你的名字]
 * GitHub项目地址：[你的GitHub地址]
 */

#include <iostream>
#include <fstream>
#include <vector>
#include <string>
#include <algorithm>
#include <iomanip>
#include <memory>
#include <sstream>
#include <limits>

// 异常处理类
class StudentManagementException : public std::exception {
private:
    std::string message;
public:
    explicit StudentManagementException(const std::string& msg) : message(msg) {}
    const char* what() const noexcept override {
        return message.c_str();
    }
};

// 学生类
class Student {
private:
    std::string id;          // 学号
    std::string name;        // 姓名
    int chinese;             // 语文成绩
    int math;                // 数学成绩
    int english;             // 英语成绩
    double average;          // 平均分
    int total;               // 总分

    // 计算平均分和总分
    void calculateScores() {
        total = chinese + math + english;
        average = static_cast<double>(total) / 3.0;
    }

public:
    // 构造函数
    Student(const std::string& id, const std::string& name, 
            int chinese, int math, int english)
        : id(id), name(name), chinese(chinese), math(math), english(english) {
        calculateScores();
    }

    // 获取学号
    std::string getId() const { return id; }
    
    // 获取姓名
    std::string getName() const { return name; }
    
    // 设置姓名
    void setName(const std::string& newName) { name = newName; }
    
    // 获取语文成绩
    int getChinese() const { return chinese; }
    
    // 设置语文成绩
    void setChinese(int score) { 
        chinese = score; 
        calculateScores();
    }
    
    // 获取数学成绩
    int getMath() const { return math; }
    
    // 设置数学成绩
    void setMath(int score) { 
        math = score; 
        calculateScores();
    }
    
    // 获取英语成绩
    int getEnglish() const { return english; }
    
    // 设置英语成绩
    void setEnglish(int score) { 
        english = score; 
        calculateScores();
    }
    
    // 获取平均分
    double getAverage() const { return average; }
    
    // 获取总分
    int getTotal() const { return total; }
    
    // 显示学生信息
    void display() const {
        std::cout << std::left << std::setw(12) << id
                  << std::setw(12) << name
                  << std::setw(8) << chinese
                  << std::setw(8) << math
                  << std::setw(8) << english
                  << std::setw(10) << total
                  << std::setw(10) << std::fixed << std::setprecision(2) << average
                  << std::endl;
    }
    
    // 转换为字符串用于文件保存
    std::string toString() const {
        std::ostringstream oss;
        oss << id << "," << name << "," 
            << chinese << "," << math << "," << english;
        return oss.str();
    }
};

// 学生管理系统类
class StudentManagementSystem {
private:
    std::vector<Student> students;
    std::string dataFile = "students.dat";
    
    // 根据学号查找学生索引
    int findStudentIndex(const std::string& id) {
        for (size_t i = 0; i < students.size(); i++) {
            if (students[i].getId() == id) {
                return static_cast<int>(i);
            }
        }
        return -1;
    }
    
    // 检查学号是否已存在
    bool idExists(const std::string& id) {
        return findStudentIndex(id) != -1;
    }
    
    // 验证成绩范围(0-100)
    bool isValidScore(int score) {
        return score >= 0 && score <= 100;
    }
    
    // 显示表头
    void displayHeader() const {
        std::cout << "\n================================================================================\n";
        std::cout << std::left << std::setw(12) << "学号"
                  << std::setw(12) << "姓名"
                  << std::setw(8) << "语文"
                  << std::setw(8) << "数学"
                  << std::setw(8) << "英语"
                  << std::setw(10) << "总分"
                  << std::setw(10) << "平均分"
                  << std::endl;
        std::cout << "--------------------------------------------------------------------------------\n";
    }
    
public:
    // 添加学生
    void addStudent() {
        std::string id, name;
        int chinese, math, english;
        
        std::cout << "\n=== 添加学生 ===\n";
        std::cout << "请输入学号: ";
        std::cin >> id;
        
        if (idExists(id)) {
            std::cout << "错误: 学号 " << id << " 已存在!\n";
            return;
        }
        
        std::cout << "请输入姓名: ";
        std::cin >> name;
        
        // 输入成绩并验证
        do {
            std::cout << "请输入语文成绩(0-100): ";
            std::cin >> chinese;
        } while (!isValidScore(chinese) && (std::cout << "成绩无效，请重新输入!\n"));
        
        do {
            std::cout << "请输入数学成绩(0-100): ";
            std::cin >> math;
        } while (!isValidScore(math) && (std::cout << "成绩无效，请重新输入!\n"));
        
        do {
            std::cout << "请输入英语成绩(0-100): ";
            std::cin >> english;
        } while (!isValidScore(english) && (std::cout << "成绩无效，请重新输入!\n"));
        
        // 添加学生到向量
        students.emplace_back(id, name, chinese, math, english);
        std::cout << "学生添加成功!\n";
    }
    
    // 删除学生
    void deleteStudent() {
        std::string id;
        std::cout << "\n=== 删除学生 ===\n";
        std::cout << "请输入要删除的学生学号: ";
        std::cin >> id;
        
        int index = findStudentIndex(id);
        if (index == -1) {
            std::cout << "错误: 未找到学号为 " << id << " 的学生!\n";
            return;
        }
        
        // 确认删除
        std::cout << "找到学生: " << students[index].getName() << std::endl;
        std::cout << "确认删除? (y/n): ";
        char confirm;
        std::cin >> confirm;
        
        if (confirm == 'y' || confirm == 'Y') {
            students.erase(students.begin() + index);
            std::cout << "学生删除成功!\n";
        } else {
            std::cout << "操作已取消\n";
        }
    }
    
    // 修改学生信息
    void modifyStudent() {
        std::string id;
        std::cout << "\n=== 修改学生信息 ===\n";
        std::cout << "请输入要修改的学生学号: ";
        std::cin >> id;
        
        int index = findStudentIndex(id);
        if (index == -1) {
            std::cout << "错误: 未找到学号为 " << id << " 的学生!\n";
            return;
        }
        
        Student& student = students[index];
        std::cout << "找到学生: " << student.getName() << std::endl;
        
        int choice;
        do {
            std::cout << "\n请选择要修改的选项:\n";
            std::cout << "1. 修改姓名\n";
            std::cout << "2. 修改语文成绩\n";
            std::cout << "3. 修改数学成绩\n";
            std::cout << "4. 修改英语成绩\n";
            std::cout << "5. 修改所有信息\n";
            std::cout << "0. 返回主菜单\n";
            std::cout << "请选择: ";
            std::cin >> choice;
            
            switch (choice) {
                case 1: {
                    std::string newName;
                    std::cout << "请输入新姓名: ";
                    std::cin >> newName;
                    student.setName(newName);
                    std::cout << "姓名修改成功!\n";
                    break;
                }
                case 2: {
                    int score;
                    do {
                        std::cout << "请输入新语文成绩(0-100): ";
                        std::cin >> score;
                    } while (!isValidScore(score) && (std::cout << "成绩无效，请重新输入!\n"));
                    student.setChinese(score);
                    std::cout << "语文成绩修改成功!\n";
                    break;
                }
                case 3: {
                    int score;
                    do {
                        std::cout << "请输入新数学成绩(0-100): ";
                        std::cin >> score;
                    } while (!isValidScore(score) && (std::cout << "成绩无效，请重新输入!\n"));
                    student.setMath(score);
                    std::cout << "数学成绩修改成功!\n";
                    break;
                }
                case 4: {
                    int score;
                    do {
                        std::cout << "请输入新英语成绩(0-100): ";
                        std::cin >> score;
                    } while (!isValidScore(score) && (std::cout << "成绩无效，请重新输入!\n"));
                    student.setEnglish(score);
                    std::cout << "英语成绩修改成功!\n";
                    break;
                }
                case 5: {
                    std::string newName;
                    int chinese, math, english;
                    
                    std::cout << "请输入新姓名: ";
                    std::cin >> newName;
                    
                    do {
                        std::cout << "请输入新语文成绩(0-100): ";
                        std::cin >> chinese;
                    } while (!isValidScore(chinese) && (std::cout << "成绩无效，请重新输入!\n"));
                    
                    do {
                        std::cout << "请输入新数学成绩(0-100): ";
                        std::cin >> math;
                    } while (!isValidScore(math) && (std::cout << "成绩无效，请重新输入!\n"));
                    
                    do {
                        std::cout << "请输入新英语成绩(0-100): ";
                        std::cin >> english;
                    } while (!isValidScore(english) && (std::cout << "成绩无效，请重新输入!\n"));
                    
                    student.setName(newName);
                    student.setChinese(chinese);
                    student.setMath(math);
                    student.setEnglish(english);
                    std::cout << "所有信息修改成功!\n";
                    break;
                }
                case 0:
                    std::cout << "返回主菜单\n";
                    break;
                default:
                    std::cout << "无效选项，请重新选择!\n";
            }
        } while (choice != 0);
    }
    
    // 查询学生
    void queryStudent() {
        int choice;
        do {
            std::cout << "\n=== 查询学生 ===\n";
            std::cout << "1. 按学号查询\n";
            std::cout << "2. 按姓名查询\n";
            std::cout << "3. 显示所有学生\n";
            std::cout << "0. 返回主菜单\n";
            std::cout << "请选择: ";
            std::cin >> choice;
            
            switch (choice) {
                case 1: {
                    std::string id;
                    std::cout << "请输入学号: ";
                    std::cin >> id;
                    
                    int index = findStudentIndex(id);
                    if (index == -1) {
                        std::cout << "未找到学号为 " << id << " 的学生!\n";
                    } else {
                        displayHeader();
                        students[index].display();
                        std::cout << "================================================================================\n";
                    }
                    break;
                }
                case 2: {
                    std::string name;
                    std::cout << "请输入姓名: ";
                    std::cin >> name;
                    
                    bool found = false;
                    displayHeader();
                    for (const auto& student : students) {
                        if (student.getName() == name) {
                            student.display();
                            found = true;
                        }
                    }
                    std::cout << "================================================================================\n";
                    if (!found) {
                        std::cout << "未找到姓名为 " << name << " 的学生!\n";
                    }
                    break;
                }
                case 3:
                    displayAllStudents();
                    break;
                case 0:
                    std::cout << "返回主菜单\n";
                    break;
                default:
                    std::cout << "无效选项，请重新选择!\n";
            }
        } while (choice != 0);
    }
    
    // 显示所有学生
    void displayAllStudents() const {
        if (students.empty()) {
            std::cout << "\n学生列表为空!\n";
            return;
        }
        
        displayHeader();
        for (const auto& student : students) {
            student.display();
        }
        std::cout << "================================================================================\n";
        std::cout << "总计: " << students.size() << " 名学生\n";
    }
    
    // 成绩统计
    void statistics() const {
        if (students.empty()) {
            std::cout << "\n学生列表为空，无法进行统计!\n";
            return;
        }
        
        std::cout << "\n=== 成绩统计 ===\n";
        
        // 各科总分和平均分
        int totalChinese = 0, totalMath = 0, totalEnglish = 0;
        int maxChinese = 0, maxMath = 0, maxEnglish = 0;
        int minChinese = 100, minMath = 100, minEnglish = 100;
        
        for (const auto& student : students) {
            int chinese = student.getChinese();
            int math = student.getMath();
            int english = student.getEnglish();
            
            totalChinese += chinese;
            totalMath += math;
            totalEnglish += english;
            
            if (chinese > maxChinese) maxChinese = chinese;
            if (math > maxMath) maxMath = math;
            if (english > maxEnglish) maxEnglish = english;
            
            if (chinese < minChinese) minChinese = chinese;
            if (math < minMath) minMath = math;
            if (english < minEnglish) minEnglish = english;
        }
        
        double avgChinese = static_cast<double>(totalChinese) / students.size();
        double avgMath = static_cast<double>(totalMath) / students.size();
        double avgEnglish = static_cast<double>(totalEnglish) / students.size();
        
        std::cout << "\n各科成绩统计:\n";
        std::cout << "科目  平均分  最高分  最低分\n";
        std::cout << "语文  " << std::fixed << std::setprecision(2) << avgChinese 
                  << "     " << maxChinese << "      " << minChinese << std::endl;
        std::cout << "数学  " << avgMath << "     " << maxMath 
                  << "      " << minMath << std::endl;
        std::cout << "英语  " << avgEnglish << "     " << maxEnglish 
                  << "      " << minEnglish << std::endl;
        
        // 按总分排序
        std::vector<Student> sortedStudents = students;
        std::sort(sortedStudents.begin(), sortedStudents.end(),
            [](const Student& a, const Student& b) {
                return a.getTotal() > b.getTotal();
            });
        
        std::cout << "\n学生总分排名:\n";
        displayHeader();
        for (size_t i = 0; i < sortedStudents.size(); i++) {
            std::cout << "[" << i + 1 << "] ";
            std::cout << std::left << std::setw(9) << sortedStudents[i].getId()
                      << std::setw(12) << sortedStudents[i].getName()
                      << std::setw(8) << sortedStudents[i].getChinese()
                      << std::setw(8) << sortedStudents[i].getMath()
                      << std::setw(8) << sortedStudents[i].getEnglish()
                      << std::setw(10) << sortedStudents[i].getTotal()
                      << std::setw(10) << std::fixed << std::setprecision(2) 
                      << sortedStudents[i].getAverage() << std::endl;
        }
        std::cout << "================================================================================\n";
    }
    
    // 保存数据到文件
    void saveToFile() {
        std::ofstream outFile(dataFile);
        if (!outFile) {
            std::cout << "错误: 无法打开文件 " << dataFile << " 进行写入!\n";
            return;
        }
        
        for (const auto& student : students) {
            outFile << student.toString() << std::endl;
        }
        
        outFile.close();
        std::cout << "\n数据已保存到文件: " << dataFile << std::endl;
    }
    
    // 从文件加载数据
    void loadFromFile() {
        std::ifstream inFile(dataFile);
        if (!inFile) {
            std::cout << "提示: 数据文件不存在，将创建新文件\n";
            return;
        }
        
        students.clear();
        std::string line;
        int count = 0;
        
        while (std::getline(inFile, line)) {
            std::istringstream iss(line);
            std::string id, name;
            int chinese, math, english;
            char comma;
            
            if (std::getline(iss, id, ',') &&
                std::getline(iss, name, ',') &&
                (iss >> chinese >> comma >> math >> comma >> english)) {
                
                if (isValidScore(chinese) && isValidScore(math) && isValidScore(english)) {
                    students.emplace_back(id, name, chinese, math, english);
                    count++;
                }
            }
        }
        
        inFile.close();
        std::cout << "\n从文件加载了 " << count << " 条学生记录\n";
    }
    
    // 显示菜单
    void showMenu() {
        std::cout << "\n========================================\n";
        std::cout << "      学生成绩管理系统 v2.0\n";
        std::cout << "========================================\n";
        std::cout << "1. 添加学生\n";
        std::cout << "2. 删除学生\n";
        std::cout << "3. 修改学生信息\n";
        std::cout << "4. 查询学生\n";
        std::cout << "5. 显示所有学生\n";
        std::cout << "6. 成绩统计\n";
        std::cout << "7. 保存数据到文件\n";
        std::cout << "8. 从文件加载数据\n";
        std::cout << "0. 退出系统\n";
        std::cout << "========================================\n";
        std::cout << "请选择操作 (0-8): ";
    }
    
    // 运行系统
    void run() {
        int choice;
        
        // 启动时自动加载数据
        loadFromFile();
        
        do {
            showMenu();
            std::cin >> choice;
            
            // 清除输入缓冲区
            std::cin.ignore(std::numeric_limits<std::streamsize>::max(), '\n');
            
            switch (choice) {
                case 1:
                    addStudent();
                    break;
                case 2:
                    deleteStudent();
                    break;
                case 3:
                    modifyStudent();
                    break;
                case 4:
                    queryStudent();
                    break;
                case 5:
                    displayAllStudents();
                    break;
                case 6:
                    statistics();
                    break;
                case 7:
                    saveToFile();
                    break;
                case 8:
                    loadFromFile();
                    break;
                case 0:
                    // 退出前询问是否保存
                    std::cout << "\n是否保存数据到文件? (y/n): ";
                    char saveChoice;
                    std::cin >> saveChoice;
                    if (saveChoice == 'y' || saveChoice == 'Y') {
                        saveToFile();
                    }
                    std::cout << "感谢使用学生成绩管理系统，再见!\n";
                    break;
                default:
                    std::cout << "无效选项，请重新选择!\n";
            }
            
            // 暂停，让用户看到结果
            if (choice != 0) {
                std::cout << "\n按Enter键继续...";
                std::cin.get();
            }
            
        } while (choice != 0);
    }
};

// 主函数
int main() {
    try {
        // 设置控制台输出编码为UTF-8（Windows系统）
        #ifdef _WIN32
        system("chcp 65001 > nul");
        #endif
        
        StudentManagementSystem system;
        system.run();
        
    } catch (const std::exception& e) {
        std::cerr << "程序发生异常: " << e.what() << std::endl;
        return 1;
    }
    
    return 0;
}
